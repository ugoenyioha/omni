# Note: This requires nginx compiled with --with-stream and --with-stream_ssl_preread_module
# Most nginx Docker images include these modules

# Main configuration for HTTP/HTTPS
events {
    worker_connections 1024;
}

http {
    # WebSocket upgrade mapping
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # Main Omni API server
    server {
        listen 443 ssl http2;
        server_name omni.home.usableapps.io;

        ssl_certificate /etc/nginx/ssl/server.crt;
        ssl_certificate_key /etc/nginx/ssl/server.key;
        
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # General proxy settings
        proxy_redirect off;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;

        # gRPC settings
        grpc_read_timeout 300;
        grpc_send_timeout 300;
        client_body_timeout 60;
        client_header_timeout 60;
        client_max_body_size 1m;

        # Default location - Web UI
        location / {
            proxy_pass http://omni:8080;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # WebSocket support
        location /ws {
            proxy_pass http://omni:8080;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # gRPC endpoints
        location ~ ^/(os\.MachineService|management\.ManagementService|auth\.AuthService|oidc\.Service|omni\.resources\.Resources|talos\.resource\.State|omni\.runtime\.Runtime|omni\.management\.ManagementService|omni\.auth\.ManagementService|talos\.storage\.StorageService|cluster\.ClusterService|talos\.cluster\.ClusterService|talos\.machine\.MachineService|machine\.MachineService|resource\.ResourceService|inspect\.InspectService|talos\.inspect\.InspectService|talos\.time\.TimeService|context\.ContextService|omni\.oidc\.Service)/ {
            grpc_pass grpc://omni:8080;
            grpc_set_header Host $host;
            grpc_set_header X-Real-IP $remote_addr;
            grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Health check
        location /healthz {
            grpc_pass grpc://omni:8080;
        }
    }

    # Kubernetes Proxy
    server {
        listen 443 ssl http2;
        server_name omni-k8s.home.usableapps.io;

        ssl_certificate /etc/nginx/ssl/server.crt;
        ssl_certificate_key /etc/nginx/ssl/server.key;
        
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        location / {
            proxy_pass http://omni:8095;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400;
        }
    }

    # Matchbox HTTP (for iPXE boot only)
    server {
        listen 80;
        server_name matchbox.home.usableapps.io;
        
        # Serve iPXE boot script and assets over HTTP
        location ~ ^/(boot\.ipxe|ipxe|assets/) {
            proxy_pass http://matchbox:8088;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Redirect everything else to HTTPS
        location / {
            return 301 https://$server_name$request_uri;
        }
    }

    # Matchbox HTTPS (web interface and API)
    server {
        listen 443 ssl http2;
        server_name matchbox.home.usableapps.io;

        ssl_certificate /etc/nginx/ssl/server.crt;
        ssl_certificate_key /etc/nginx/ssl/server.key;
        
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Matchbox web interface and API
        location / {
            proxy_pass http://matchbox:8088;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Matchbox gRPC API
        location ~ ^/matchbox\. {
            grpc_pass grpc://matchbox:8081;
            grpc_set_header Host $host;
            grpc_set_header X-Real-IP $remote_addr;
            grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            grpc_set_header X-Forwarded-Proto $scheme;
        }

        # For iPXE boot scripts
        location ~ \.(ipxe|txt)$ {
            proxy_pass http://matchbox:8088;
            proxy_set_header Host $host;
            add_header Content-Type text/plain;
        }

        # For kernel and initrd downloads
        location /assets/ {
            proxy_pass http://matchbox:8088;
            proxy_set_header Host $host;
            proxy_buffering off;
        }
    }
}

# Stream module for TCP passthrough
stream {
    map $ssl_preread_server_name $upstream {
        omni-siderolink.home.usableapps.io omni_siderolink_backend;
        default https_backend;
    }

    upstream omni_siderolink_backend {
        server omni:8090;
    }

    upstream https_backend {
        server 127.0.0.1:8443;
    }

    server {
        listen 443;
        ssl_preread on;
        proxy_pass $upstream;
    }

    # Move HTTPS to internal port 8443
    server {
        listen 127.0.0.1:8443 ssl;
        # This will be handled by the http block above
    }
}